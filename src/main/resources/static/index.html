<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.bootcss.com/socket.io/2.2.0/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
<h1 id="message">connecting...</h1>
<div id="question"></div>
<br/>
<div id="countdown"></div>
<br/>
<div id="answers"></div>
<br/>
<hr/>
<div id="numberStudentAnswered"></div>
<div id="questions"></div>
<br/> Number of student in challenge:
<div id="numberStudentInChallenge"></div>
<div id="students"></div>
<script>
    const challengeId = 219;

    const token = "Bearer " + "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbjEiLCJleHAiOjE2Mzc5NjI0OTgsImlhdCI6MTYzNzYwMjQ5OH0.h-rAtJ9w2iZ6VnraXtDG3yHDTuNEyWgAJe3548vCKCU";

    let numberStudentInChallenge = 0;

    let numberStudentAnswered = 0;

    $.ajax({
        type: "GET",
        beforeSend: function (request) {
            request.setRequestHeader("Authorization", token);
        },
        url: "/host/challenge/live?challengeId=" + challengeId,
        success: function (data) {
            console.log("student in challenge ",data);
        },
        error: data => {
            console.log(data);
        }
    });


    const socketurl = "http://159.223.38.181:8082";
    // const socketUrl = "http://localhost:8082"
    const socket = io.connect(socketUrl, {
        query: "challengeId=" + challengeId
    });

    socket.on("connected", (data) => {
        $("#message").append("<br/><b> " + data + "</b>");
    }).emit('registerHostSocket', { // event name
        challengeId: challengeId,
        token: token
    });

    // handle publish question event
    socket.on("publishQuestion", (data) => {
        const question = data.id + ":" + data.ordinalNumber + " Ask date: " + data.askDate + "<br/> <img height='200px' src='" + data.questionContent + "'/> <br/>" + data.answerTimeLimit + " " + data.point + " " + data.answerOption;
        document.getElementById("question").innerHTML = question;
        let answersText = "";
        let answers = [];
        data.publishAnswerResponses.forEach(e => {
            answersText += "<button class='answer' data-id='" + e.id + "'>" + e.id + ":" + e.ordinalNumber + ". " + e.answerContent + "</button>";
        });
        document.getElementById("answers").innerHTML = answersText;

        this.numberStudentAnswered = 0;
        document.getElementById("numberStudentAnswered").innerHTML = this.numberStudentAnswered + "/" + this.numberStudentInChallenge;

        clearInterval(downloadTimer);

        countdown(data.answerTimeLimit)
    });

    socket.on("studentAnswer", data => {
        this.numberStudentAnswered ++;
        document.getElementById("numberStudentAnswered").innerHTML = this.numberStudentAnswered + "/" + this.numberStudentInChallenge;
    });



    socket.on("joinRequest", data => {
        // $("#message").append("<br/><button onclick='allow(" + data + ")'> allow " + data + "</button>");
        // $("#message").append("<button onclick='deny(" + data + ")'> deny " + data + "</button>");

        console.log("new student join")
    });

    function allow(id) {
        console.log(id);
    }

    function deny(id) {
        console.log(id);
    }


    // update student in challenge every 5 second

    var myVar = setInterval(myTimer, 5000);

    var students = "";
    var studentInChallenges = [];

    var that = this;

    function myTimer() {
        $.ajax({
            type: "GET",
            beforeSend: function (request) {
                request.setRequestHeader("Authorization", token);
            },
            url: "/host/studentOnline?challengeId=" + challengeId,
            success: function (data) {
                that.studentInChallenges = data;
            },
            error: data => {
                console.log(data);
            }
        });

        students = "";

        studentInChallenges.forEach(e => {
            students += "<button>" + e.studentUsername + "</button>";
        });
        this.numberStudentInChallenge = studentInChallenges.length;
        document.getElementById("numberStudentInChallenge").innerHTML = this.numberStudentInChallenge;
        document.getElementById("students").innerHTML = students;


    }

    // stop interval
    function myStopFunction() {
        clearInterval(myVar);
    }


    // sent question

    function publishQuestion(questionId) {
        $.ajax({
            type: "GET",
            beforeSend: function (request) {
                request.setRequestHeader("Authorization", token);
            },
            url: "/host/publishQuestion?questionId=" + questionId,
            success: function (data) {

            },
            error: data => {
                console.log(data);
            }
        });
    }

    // get all question, start challenge

    $.ajax({
        type: "GET",
        beforeSend: function (request) {
            request.setRequestHeader("Authorization", token);
        },
        url: "/host/startChallenge?challengeId=" + challengeId,
        success: function (data) {
            let questionsText = "";
            data.forEach(e => {
                questionsText += "<button class='question' data-id='" + e.id + "' onclick='publishQuestion(" + e.id + ")'>" + e.id + ":" + e.ordinalNumber + ". " + e.questionContent + "</button>";
            });
            document.getElementById("questions").innerHTML = questionsText;
        },
        error: data => {
            console.log(data);
        }
    });

    var downloadTimer;

    function countdown(timeleft) {

        downloadTimer = setInterval(function () {
            if (timeleft <= 0) {
                clearInterval(downloadTimer);
                document.getElementById("countdown").innerHTML = "Finished";
            } else {
                document.getElementById("countdown").innerHTML = timeleft + " seconds remaining";
            }
            timeleft -= 1;
        }, 1000);
    }


</script>
</body>
</html>